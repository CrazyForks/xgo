# Cause of `error not instrumented by xgo`
When mock setup fails:
```go
package main

import "third.party/pkg"

func TestThirdPackage(t *testing.T){
    mock.Patch(pkg.DoSomething, func() string{
        return "mock"
    })
}
```

With the following msg:
```
func not instrumented by xgo,...
```

It means there is not trap point inserted by xgo, either because the package is not in main module, or there is some inherent limitation.

# When will this error happen?
`xgo` scans the main module to find all `fn` such that they are provided to `mock.Patch(fn,...)` and `mock.Mock(fn,...)`, then insert trap points on these functions.

However, due to performance issue, such scan only looks files in the main module. If the `mock.Patch` call happens in third party package, `xgo` ignores them. 

Moreover, if `fn` is referenced via `interface`, then `xgo` cannot figure out the function statically, so will not insert trap point for it:
```go
// some/pkg
type Reader interface {
    Read(data []byte) (int,error)
}
func NewReader() Reader {
    ...
}

// main module
func TestInterface(t *testing.T){
    reader := pkg.NewReader()
    // xgo cannot detect reader's type statically
    // see below sections for solution.
    mock.Patch(reader.Read, func(data []byte) (int,error){
        ...
    })
    ...
}

```

# Variables
`xgo` supports trapping variables, but only variables in main module can be mocked.

# How to solve?
## Option 1: `--trap pkg1 --trap pkg2`
By default xgo will only insert trap for packages of main module, which is resolved by `go list ./...`, and functions provided to `mock.Patch` and `mock.Mock`.

Packages not trapped by xgo cannot be mocked, the setup naturally fails.

To add extra packages for trapping, you can specify `--trap pkg`:
```sh
xgo test --trap third.party/pkg <remaining args...>
```

To add more packages, repeat this option multiple times.

You can also specify `--trap third.part/...` to trap for all packages under `third.part`, including itself.

## Option 2: `--trap-all`
This causes `xgo` to call `go list` with `-deps` flag, and then insert trap points on all packages.

This can slow down the compilation process a little bit for large projects with hundreds dependency.

# Limitations on stdlib
Due to performance and security reason, xgo by default only trap a very small portions [runtime/mock/STDLIB.md](../runtime/mock/STDLIB.md).

Like:
```
# time
Now()
Sleep()

# os/exec
(*Cmd).Run()
(*Cmd).Output()

# net/http
Get()
...
```

If there is some stdlib function not instrumented by xgo, and you really need it,you can leave a comment in [Issue#6](https://github.com/xhd2015/xgo/issues/6).

# Limitations on generic functions and methods in Go 1.18 and Go 1.19
If you need to mock generic functions and methods, please upgrade to `go1.20` and later.

`xgo` cannot instrument generic functions and methods in go1.18 and go1.19, since in this two early versions that support generic, the implementation is very hack.

generic functions are implemented in closure, which is implicitly generated by the compiler at each place that generic instance is referenced.

Since `xgo v1.1.0` drops support for closure, generic implemented such way is no longer supported.

However, later and latest go version works fine.